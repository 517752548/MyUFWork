-- Generated by CSharp.lua Compiler
local System = System
local ET
local DictInt64Session
System.import(function (out)
  ET = out.ET
  DictInt64Session = System.Dictionary(System.Int64, ET.Session)
end)
System.namespace("ET", function (namespace)
  namespace.class("NetworkComponent", function (namespace)
    local Awake, Awake1, getCount, OnAccept, Remove, Get, Create1, Create2, 
    Update, Dispose, __ctor__
    __ctor__ = function (this)
      this.Sessions = DictInt64Session()
      ET.Entity.__ctor__(this)
    end
    Awake = function (this, protocol)
      repeat
        local default = protocol
        if default == ET.NetworkProtocol.KCP then
          local extern = ET.KService()
          extern:setParent(this)
          this.Service = extern
          break
        elseif default == ET.NetworkProtocol.TCP then
          local extern = ET.TService()
          extern:setParent(this)
          this.Service = extern
          break
        elseif default == ET.NetworkProtocol.WebSocket then
          local extern = ET.WService()
          extern:setParent(this)
          this.Service = extern
          break
        end
      until 1
    end
    Awake1 = function (this, protocol, address)
      System.try(function ()
        local ipEndPoint
        repeat
          local default = protocol
          if default == ET.NetworkProtocol.KCP then
            ipEndPoint = ET.NetworkHelper.ToIPEndPoint1(address)
            local extern = System.new(ET.KService, 2, ipEndPoint, function (channel)
              this:OnAccept(channel)
            end)
            extern:setParent(this)
            this.Service = extern
            break
          elseif default == ET.NetworkProtocol.TCP then
            ipEndPoint = ET.NetworkHelper.ToIPEndPoint1(address)
            local extern = System.new(ET.TService, 2, ipEndPoint, function (channel)
              this:OnAccept(channel)
            end)
            extern:setParent(this)
            this.Service = extern
            break
          elseif default == ET.NetworkProtocol.WebSocket then
            local prefixs = address:Split(59 --[[';']], nil, 0)
            local extern = System.new(ET.WService, 2, prefixs, function (channel)
              this:OnAccept(channel)
            end)
            extern:setParent(this)
            this.Service = extern
            break
          end
        until 1
      end, function (default)
        local e = default
        System.throw(System.Exception("NetworkComponent Awake Error " .. address, e))
      end)
    end
    getCount = function (this)
      return this.Sessions:getCount()
    end
    OnAccept = function (this, channel)
      local session = ET.EntityFactory.CreateWithParent2(this, channel, ET.Session, ET.AChannel)
      this.Sessions:AddKeyValue(session.Id, session)
      channel:Start()
      return session
    end
    Remove = function (this, id)
      local session
      local default
      default, session = this.Sessions:TryGetValue(id)
      if not default then
        return
      end
      this.Sessions:RemoveKey(id)
      session:Dispose()
    end
    Get = function (this, id)
      local session
      local _
      _, session = this.Sessions:TryGetValue(id)
      return session
    end
    -- <summary>
    -- 创建一个新Session
    -- </summary>
    Create1 = function (this, ipEndPoint)
      local channel = this.Service:ConnectChannel(ipEndPoint)
      local session = ET.EntityFactory.CreateWithParent2(this, channel, ET.Session, ET.AChannel)
      this.Sessions:AddKeyValue(session.Id, session)
      channel:Start()
      return session
    end
    -- <summary>
    -- 创建一个新Session
    -- </summary>
    Create2 = function (this, address)
      local channel = this.Service:ConnectChannel1(address)
      local session = ET.EntityFactory.CreateWithParent2(this, channel, ET.Session, ET.AChannel)
      this.Sessions:AddKeyValue(session.Id, session)
      channel:Start()
      return session
    end
    Update = function (this)
      if this.Service == nil then
        return
      end
      this.Service:Update()
    end
    Dispose = function (this)
      if this:getIsDisposed() then
        return
      end

      ET.Entity.Dispose(this)

      this.Service:Dispose()
    end
    return {
      base = function (out)
        return {
          out.ET.Entity
        }
      end,
      Awake = Awake,
      Awake1 = Awake1,
      getCount = getCount,
      OnAccept = OnAccept,
      Remove = Remove,
      Get = Get,
      Create1 = Create1,
      Create2 = Create2,
      Update = Update,
      Dispose = Dispose,
      __ctor__ = __ctor__
    }
  end)
end)
