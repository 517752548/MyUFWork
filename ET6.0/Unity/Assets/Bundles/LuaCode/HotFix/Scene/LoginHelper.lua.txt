-- Generated by CSharp.lua Compiler
local System = System
local ET = ET
local ETEventType = ET.EventType
System.namespace("ET", function (namespace)
  namespace.class("LoginHelper", function (namespace)
    local Login
    Login = function (zoneScene, address, account)
      return System.async(function (async, zoneScene, address, account)
        System.try(function ()
          -- 创建一个ETModel层的Session
          local r2CLogin
          System.using(zoneScene:GetComponent(ET.NetOuterComponent):Create(address), function (session)
            local default = ET.C2R_Login()
            default:setAccount(account)
            default:setPassword("111111")
            r2CLogin = System.cast(ET.R2C_Login, async:Await(session:Call(default)))
          end)

          -- 创建一个gate Session,并且保存到SessionComponent中
          local gateSession = zoneScene:GetComponent(ET.NetOuterComponent):Create(r2CLogin:getAddress())
          zoneScene:AddComponent(ET.SessionComponent).Session = gateSession

          local default = ET.C2G_LoginGate()
          default:setKey(r2CLogin:getKey())
          default:setGateId(r2CLogin:getGateId())
          local g2CLoginGate = System.cast(ET.G2C_LoginGate, async:Await(gateSession:Call(default)))

          ET.Log.Info("登陆gate成功!")

          local extern = ETEventType.LoginFinish()
          extern.ZoneScene = zoneScene
          async:Await(ET.Game.getEventSystem():Publish(extern, ETEventType.LoginFinish))
        end, function (default)
          local e = default
          ET.Log.Error(e)
        end)
      end, nil, zoneScene, address, account)
    end
    return {
      Login = Login
    }
  end)
end)
