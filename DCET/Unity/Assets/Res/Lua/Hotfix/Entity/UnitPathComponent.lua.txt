-- Generated by CSharp.lua Compiler
local System = System
local UnityEngine = UnityEngine
local ListVector3 = System.List(UnityEngine.Vector3)
local DCET
System.import(function (out)
  DCET = out.DCET
end)
System.namespace("DCET", function (namespace)
  namespace.class("UnitPathComponent", function (namespace)
    local StartMove, StartMove1, __ctor__
    __ctor__ = function (this)
      this.Path = ListVector3()
      this.ServerPos = System.default(UnityEngine.Vector3)
      System.base(this).__ctor__(this)
    end
    StartMove = function (this, cancellationToken)
      return System.async(function (async, this, cancellationToken)
        for i = 0, #this.Path - 1 do
          local v = this.Path:get(i)

          local speed = 5

          if i == 0 then
            -- 矫正移动速度
            local clientPos = this:GetParent(DCET.Unit):getPosition()
            local serverf = (UnityEngine.Vector3.op_Subtraction(this.ServerPos, v)):getmagnitude()
            if serverf > 0.1 then
              local clientf = (UnityEngine.Vector3.op_Subtraction(clientPos, v)):getmagnitude()
              speed = clientf / serverf * speed
            end
          end

          this:getParent():GetComponent(DCET.TurnComponent):Turn(v:__clone__(), 0.100000001)
          async:await(this:getParent():GetComponent(DCET.MoveComponent):MoveToAsync(v:__clone__(), speed, cancellationToken))
        end
      end, nil, this, cancellationToken)
    end
    StartMove1 = function (this, message)
      System.async(function (async, this, message)
        -- 取消之前的移动协程
        local default = this.CancellationTokenSource
        if default ~= nil then
          default:Cancel()
        end
        this.CancellationTokenSource = System.CancellationTokenSource()

        this.Path:Clear()
        for i = 0, #message.Xs - 1 do
          this.Path:Add(UnityEngine.Vector3(message.Xs:get(i), message.Ys:get(i), message.Zs:get(i)))
        end
        this.ServerPos = UnityEngine.Vector3(message.X, message.Y, message.Z)

        async:await(StartMove(this, this.CancellationTokenSource:getToken()))
        this.CancellationTokenSource:Dispose()
        this.CancellationTokenSource = nil
      end, true, this, message)
    end
    return {
      base = function (out)
        return {
          out.DCET.Entity
        }
      end,
      StartMove = StartMove,
      StartMove1 = StartMove1,
      __ctor__ = __ctor__
    }
  end)
end)
